### 6. Multisite acquisition

The Multisite acquisition client is used to set up the FIB-SEM run including ROI and recipe for every region to be acquired (e.g. width, height, depth). 

#### 6.1 Creating a new project

1) Start the Multisite. The Connect and save state are the same as in the Navigator. First load all the maps and fill the information about the project, and then Connect and Save state.

![image-20210616083103955](.\imgs\image-20210616083103955.png)

2) First, fill the form about the project

 This will generate a list of folder names for each acquisition on the sample.



​              ![img](.\imgs\clip_image004_xxxxsd.jpg)



Fill the information about the project:

- Project Title, the name of your project
- That will create a folder and on each there will be one folder per acquistion. The individual folders will be numbered from 0000 to N. We have the possibility to add a name to each folder in "Sample general name", or to add the same names as they already have from the map session (or both together). You can also append the date at the end of the name. 
- Additionally the folders will start from 0000 to onwards. You can change also the numbering to start with. 



3) Then select your profile

The Profile file and setup file are generated by the Atlas Engine. The user can select them using the ‘Add New button’, and they will be copied locally in the main application directories for further usage.

**Setup** is the recipe in the format .a3d-setup saved from your AtlasEngine. Loading this file should provide the program with  ROI, B&C, detectors and keyframe preferences.  Click on plus to find the file on your system and add it. You can add as many recipes as you want, the one here selected will be the general one, the other can be assigned individually later in the drop list. 

![image-20210616084850243](.\imgs\image-20210616084850243.png)

4)  Select the ROI

 It refers to the ROI FOV, which is the width and height of the imaging box. You have to specify it in micrometers. Since it is a little bit difficult, just explore the size first and give a little bit of room (2-3 micrometers more on each direction than you need to enclose your region). 

![image-20210616085341094](.\imgs\image-20210616085341094.png)

The user can specify several regions of interest for each sample, just type the values and click on the plus button to add a new region. The region selected here will be the one applied by default, the others can be changed later in the drop list for each individual sample.

NOTE: It is recommended that when you save the files, you give meaningful names by annotating the dimensions (like in the example), for example, the imaging ROI can be stored as  `img_roi_depth_height_width.json`  and the recipe as  `name_roiwidth_roiheight_sectionsize_resolution_nm.a3d-setup`.



Once the user fills the form, it is important to save the project (.prj format). This project saving is very important because once the map is loaded, it will be able to save and restore at the state, so if the running crashes or we need to close the microscope for any other reason and retake the work later, all the information is here.

Multisite can work in two modalities:

![image-20210616200124465](.\imgs\image-20210616200124465.png)

1) Map icon. By loading a session using the .json file.

2) Green dot icon. By loading a .xml of coordinate targets. The procedure is the same as loading the session, except that there is no recalculation of local positions, which usually increases the targeting precision. If you don't mind (you are milling over a large area), just load the targets.

**NOTE**: Even if this is a CLEM tool,  it could be possible to acquire any desired positions in the Navigator, then use it in the Multisite here to perform automatic acquisitions. 

You can  use the format MarkAndFindPoints where PointRef are the Points in the drawing map and  Point are the positions:

![image-20210616224923806](.\imgs\image-20210616224923806.png)



#### 6.2 Loading a map



![image-20210616132749914](.\imgs\image-20210616132749914.png)

Now we can proceed to the ‘Samples list’ form. 

The user can then load an .json map file from a session saved from the navigator. The ‘samples list’ shows a table where each position is an individual target. 

The general settings from the previous form are applied to all sample positions: the recipe .a3d-setup and ROI FOV is the same for all the samples as selected in the menu before. 

However, in case the user is interested in using a particular group of settings for one target,  he can change manually the setup and ROI by going to the row and dropping down the combobox. By clicking, the new setup or ROI is loaded for that particular sample.

Targets can be discarded from the automated acquisition by  unchecking the box in the ‘To-do’-column.

By dragging and dropping rows is it possible to arrange and sort the target cells, which will determine the order in which they will be acquired in the FIB-SEM.  Do this before START, you cannot sort once the automated acquisition has started.



Thus:

1) Load the session you saved in CLEMSite Navigator after running an automated scan. Check that is ok, review the list of cells, do all sortings and assignments of ROI and setups, or remove from the TO DO list.

2) Save the project.

3) Review that the microscope conditions are right before starting (Connected and save state are in green, check the document [README/Before start](./README.md)). Check that the cells showing on the map correspond to your targets.

![animation1](.\imgs\animation1.gif)



4) Click start to begin. 

![animation2](.\imgs\animation2.gif)

When a user clicks on start, the server is blocked for other potential client requests (like the Navigator) and it works exclusively with this client. All start automatically.

5)  After this, a series of automatic steps will drive the microscope for the CP. If this is a map session (not just coordinates), it will follow a new step of recalibration of the current position.  

![img](.\imgs\clip_image007_n.jpg)



- Then it  will start milling of a trench. 

  **IMPORTANT:** After the trench is milled, the user will be prompted **twice** to adjust B&C and then, click on ok. 

  - The first time is the B&C for image acquisition. Do it with the help or SmartSEM and press OK when ready.
  - The second is for the AFAS algorithm, where on occasions, a different histogram is required to achieve optimal conditions in the AFAS. These values of B&C will be used again for all subsequent cells acquired in the sample.

6)  The next step is the AFAS. 

You might be asked to provide a focus (first focus).  You have to do it only once in the full Multisite acquisition to provide an initial focus.

7) The monitoring starts you can live the microscope to run unattended. 



#### 6.3 During the run

Each target is displayed in a row. Each row shows if the cell has to be acquired (To do), the names (Sample), X,Y,Z stage coordinates in SEM of target cell, field of view to acquire (ROI FOV), recipe used for that specific cell (Setup) and folder where data is stored (Folder Name). 

In the sample list each row displays a different status: 

- GREEN Status -> before being acquired 
- YELLOW Status ->  being acquired at the moment 
- ORANGE Status -> cell is being too close to a neighbouring cell, which can cause problem with CP detection.
- RED Status -> skipped/cancelled/failed cell 
- PURPLE Status -> Completed, already acquired cell 

By selecting one row, we can change the GREEN or ORANGE status to READY (green), COMPLETED (purple) or CANCELLED (red). This controls are used to organize data better in the proje



![img](.\imgs\clip_image003_n.gif)



In addition, in **3**, messages sent by CLEM*Site* Server to the client show the status of the current acquisition (e.g., slice number, autofocus executed, paused, etc..).

In the messages box, the current status of the sample will be shown but if important events happen during the run, a message box will pop up warning the user. Every information in the message box is also recorded in a log file.



There are some additional controls to operate (**2**):

**Main Controls (left to right):**

●    **Start the run.** Clicking on the play button. One by one, all locations will be executed, unless the system is paused.

●    **Pause.** 

●    **Resume acquisition after pause.**   Use it in combination to pause to stop imaging. It will not stop milling, but it will stop imaging and allow you to operate things like focus or retract, advance mill manually, then resume. 

●    **Skip**. The current row target is cancelled and the microscope moves to the next location.

●    **Picture.** Show folder with acquired images

●    **Stop.** Stops the acquisitions (completely, it does not go to the next).The current project is cancelled and the communication with the server is stopped.

Below:

●    **Save changes.** Save button

●    **Select all.**  All the rows are set to To Do.

●    **Unselect all.** Unselect all the To Do from the rows.   



#### 6.4   *Multisite* description of menu Options

**File:**

●     **Load List:** Loading list (xml-file) of targets and landmarks computed with *Navigator.*

●     **Load Map:** Loading the full session not just the list.

●     **Save Project:** Saving *Multisite* session status of the different targets acquired (not yet acquired, in progress, cell very close to another cell, acquisition cancelled/failed).

●     **Load Project:** Loading *Multisite* session status of the different targets acquired (not yet acquired, in progress, cell very close to another cell, acquisition cancelled/failed).

●     **Update Map:** Updating map. If the original position has been changed for example after interruption of the session, you can align to a previous scan and update the coordinates.

 

**Actions:**

●    **Run:** Start the acquisition of the first cell in the sample list.

●    **Stop:** The acquisition is stopped and any communication with the microscope is finalized.

●    **Pause:** It will stop imaging (not milling) until further orders.

●    **Resume:** If the run was paused, the imaging and acquisition can be continued.

●    **Push new BC:** After changing B&C values on the microscope, the new values are transferred to CLEM*Site* and kept for further imaging. 

●    **Stop after acquisition ends:** The acquisition is stopped after the current acquisition is finished.

●    **Execute AFAS:** The autofocus/autostigmation routine is executed.

●    **Swap CP:** Coincidence point routine can be performed 50 µm to the left or the right side of the target cell. Default is into the left, when for any reason the CP failed, click here to swap CP sides.





#### 6.5 Acquisition scheme. How does it work?

We recommend to read this together with the article to have a better understanding of the workflow.

#####  6.5.1. Step 1: Positioning and Automatic Coincidence Point

The setup file and ROI FOV (width and height) is sent to the server and it creates a folder to save the setup file and all files generated during the acquisition. All information inside the setup file is modified, including the information of the specific target: folder names where images are stored, position, B&C, WD and Autotune box parameters. This is achieved by using a class inside the server that overwrites the xml file each time that a value is changed during the workflow. The modified setup file will be given to the Atlas 3D API before starting the acquisition.

After receiving the setup file, ROI FOV and target cell position information, the microscope moves to the position and shifts 50 µm in the x direction. This shift is necessary to accommodate the coincidence point requirements.  After this, the code bifurcates. If a map is present in the client, the client will proceed to recalculate the transform. The green marked square in the figure means that these operations are performed by the client, not by the server. 

 

 

![img](.\imgs\clip_image009_n.jpg)

**Positioning and Automatic Coincidence Point.** The SEM stage is moved to the precise position in stage coordinates of the target cell. This position will be the center of the region to be acquired. The coincidence point is automatically detected 50 µm away from the target cell. 

 

If in the multisite acquisition a map was provided, control is transferred back to the client application. The client application will perform a recalculation of the original position. First, it will extract a list of the closest landmarks to the target position. With this list ready, it will apply the instructions highlighted with a green dotted line in Flowchart 2, for at least 4 landmarks. Then, a new affine transformation will be computed and the original position will be overwritten and sent to the server again. 

 

##### **6.5.2. Step 2: Trench, polish and automatic detection of trench**

The next step is to mill a trench and polish the imaging surface. The trench uses a high current to expose the cross section of the target cell. It has a trapezoid shape to favour the accumulation of milled material to the side walls of the trench. Right after the trench, a lower FIB current mills a small rectangle at the cross-section face, to polish the surface. This step is recommended to achieve better initial autofocus and to clean the surface of charging ions generated by the use of coarse currents. Trench and polish are performed using the Fibics API with the parameters defined previously in the Atlas 3D setup files. 

Next, the trapezoid shape of the trench is imaged using the EsB detector. The image is thresholded and the shape of a trapezoid detected. The top corner and centroid of the trapezoid in the image are detected and the center of the FOV is positioned in the exposed cross-section using beam shift.

 

![img](.\imgs\clip_image011_n.jpg)



**Algorithmic sequence to detect trench.** In the red box, a call is made to Fibics API functions for milling a trench and polish. Images are taken before and after the milling to quickly find elements by the difference between images. With the image of the difference, auto thresholding is applied to find darker components (milled shapes). Since detection is based on thresholding, the user has to balance properly B&C of the EsB detector before starting. An alternative path not described in the figure is executed if Otsu thresholding fails in finding components, then the same sequence is executed but using the SLIC Thresholding algorithm instead of Otsu. After segmentation using connected components (labelling individual objects), a polynomial is fitted to the contour of each object to find the top and bottom corners of the trapezoid. Then, the centroid of the figure is obtained. If the contour geometrically fits to be a trapezoid and its area is in an acceptable range, the object is stored as a potential trapezoid. From the list of trapezoid candidates, the selected trapezoid is always the closest to the image center. 

 

##### 6.5.3. **Step 3: ESB contrast, Autotune Box positioning and AFAS** 

After centering the FOV in the centroid of the trapezoid, the following steps are executed

●          **Brightness and contrast for acquisition.** In B&C for acquisition the purpose is to achieve the ideal dynamic range in grey values for the EsB detector imaging. This is subjective to the user’s perspective, where ideally the gray scale image covers the full histogram range. During B&C adjustment for acquisition (EsB detector), only the FOV part of the milled region has to be considered (cross-section of the cell or tissue). When including the top surface of the block in the FOV, the gold coating of the surface tends to saturate to white values. These have to be ignored for a proper B&C balance in the image of the cross-section. The user is asked to provide these values, only for the first cell acquired. They are stored and subsequently used for every target. Mounted blocks quite often have a slight tilt and the B&C of the SEM depends on how many electrons impact on the surface to form an image. Consequently, there is always a slight variation of B&C between images acquired at different positions of the resin block. An ideal scenario would be to create an auto B&C algorithm based on the segmentation of the imaging region. However, after several non-conclusive trials and for simplicity, the user has to set up B&C values manually at the beginning of the run. If the resin block is stable and flat enough, this solution works reasonably well. In case that in the future we want to expand to bigger samples with more surface irregularities, an auto B&C algorithm will have to be implemented.

 

●          **Brightness and contrast for focus and stigmatism.** Fibics developed an algorithm for AFAS which is used on the cross-section face. This algorithm was designed to work with marks on a deposition layer filled with a second material giving a binary contrast between the two layers. The autotune marks require a well-balanced grey level histogram to differentiate high frequencies in the image. Thus, a different set of B&C values is required by the algorithm compared with those for imaging. An autofocus requires a more balanced histogram (best possible dynamic range) in the full FOV (not only in the cross-section), avoiding saturation towards white or black. In many occasions, when the sample preparation is excellent (membranes are well differentiated in the biological specimen), the distinction of these two sets of B&C values is irrelevant. When set, these values are stored and used for every further target cell.

 

●          **Autofocus and autostigmatism functions (AFAS).** The main goal of this is to provide a good initial focus and stigmatism of the cross-section before starting the slice and view process. The Fibics API provides an algorithm for AFAS which operates with a user given set of parameters. An example of those parameters is given on each row of Table 1. The autofocus routine is split from wide ranges to very narrow ones in order to find an optimal focus, in similar ways to a parameter grid search. Four different focus steps are performed: very wide, twice at medium range and finally very accurate.

 

|               | PixelSize | Range | Dwell time | Line Average |
| ------------- | --------- | ----- | ---------- | ------------ |
| AF Coarse     | 0.1       | 100   | 7          | 1            |
| AS Coarse     | 0.1       | 10    | 7          | 1            |
| AF Medium 1st | 0.01      | 25    | 8          | 2            |
| AF Medium 1st | 0.01      | 5     | 8          | 2            |
| AF Medium 2nd | 0.005     | 25    | 8          | 2            |
| AS Medium 2nd | 0.005     | 5     | 8          | 2            |
| AF Medium 2nd | 0.005     | 25    | 8          | 2            |
| AF Fine       | 0.0015    | 10    | 9          | 2            |
| AS Fine       | 0.0015    | 1     | 9          | 2            |
| AF Fine       | 0.0015    | 10    | 9          | 2            |

**Table 1. Autofocus and autostigmatism** **values for each execution of Fibics AFAS algorithm.** This table is stored in a file that can be modified and adapted if needed.

 

Additionally, AFAS functions cannot be executed anywhere on the cross-section. It requires regions with high frequency elements and with high contrast, usually provided by marks performed in the deposition layer by the user in a manual workflow. In the current workflow, marks are not milled; an algorithm that searches maximum variation of intensity in the cross-section face is used. When one of these regions is found it is selected as a region to apply the auto functions. This approach has been proven to work well in the majority of the cases.

The points selected for the autotune function (Figure, blue points). First, between 100 and 200 ridges are detected using a Harris corner detector (red points). Points are clustered using a total of 25 points in k-means (green points). Green points are ranked based both on proximity to the gold interface and on the standard error variation of grey values on a 50x50 pixel patch (bigger variation is considered better). 

 

 

![image-20210616225144003](.\imgs\image-20210616225144003.png)

**Sequence for B&C and AFAS algorithm.** Left side marked with dotted line, only occurs once at the beginning of the run. 1) The light blue dot marks the bottom of the FOV and the dark blue dot is placed at 85% of its height. Left red dot on image 1 (upper left corner of the trapezoid) is used to place the AFAS box for Autotune, as shown on image 2. 3) The region covers a part of the so-called interface, usually covered by a thick layer of gold over the surface. From 1 to 6 in blue, which points have been selected for AFAS, based on maximum contrast variation. In green, other candidate positions are discarded (only the first 6 maximum variation points are selected). Each point has been surrounded by a patch normalized. The image allows us to observe differences in frequency of the region surrounding the selected point marked by the patch.

 

#### 6.6    Monitoring the acquisition 

Once CLEM*Site* starts to acquire the first dataset, two passive threads are started. 

The first thread sends continuous messages to the client about the acquisition progress. In case of a problem, like an unexpected exception, a message is sent to the client application and the run is stopped. Upon completion of an acquisition, the client application is informed to proceed sending further instructions and parameter values (position, setup file, cross-section ROI) for the next acquisition. 

A second thread is in charge of monitoring the folder where images are stored. It performs checkups by combining information from Atlas 3D logs and the most recent acquired image. These checks involve autotune functions, tracking and ending detection (see next paragraphs). 

The checking is performed by an independent process called *RunChecker* which is executed in two main steps:

- first, analysis on current data is performed (Figure below, green box)
- second, this information stored in a file called runcheck.csv. From there  a set of coordinates for placing the Autotune box (see Autotune functions). A timer is triggered to compute new AFAS regions at least 2 minutes before an AFAS operation is executed. The second, is the number of microns in the Y direction that the FOV image needs to be moved in case of a drift. This is computed comparing the relative displacement between two consecutive cross sections, the current one and the previous one. 

![image-20210616225251235](.\imgs\image-20210616225251235.png)

​                                  



Additionally, in an active way, users can cancel the ongoing acquisition if they detect any problem, e.g. the targeted region is not correct or the region reached ended before expected. 

##### 6.6.1  Autotune functions

An _Autotune_ is a periodically triggered event with the goal of maintaining a crisp image. Parameter values of AFAS have to be specified by the user before the run. During the acquisition run, the function is triggering an AFAS at a specified time interval, usually every 30 or 45 minutes. An AFAS function is executed in a small window within the FOV (corresponding to 20-30% of its width and height) called *Autotune box*. 

In Atlas 3D, the user positions the box on a series of marks present in the protection pad that have been deposited previously. These functions can result in a success or fail state. If it succeeds, current values are updated to new ones, otherwise the values remain the same. When the marks are present, Atlas 3D uses cross correlation to track each section and to guarantee that shifts don’t affect the final outcome. In the current automated workflow, and for the sake of simplicity and speed,  the Autotune box was placed in the interface (place between resing and air at the top, where the gold coating is located). However, if parts of the imaged cross-section display regions with a good dynamic range and with high frequency components, the autotuned box is placed there, guaranteeing better focus and stigmation for the current sample. 

##### **6.6.2  Tracking **

The tracking algorithm is used to compensate images shifted up or down. Shifts in y direction are more frequent, especially at the beginning of the acquisition.  Drifting is a side effect of temperature changes (introduced by stage movement or by the ion and electron beams interactions with the sample) and, also as a consequence of the physical slicing which changes the cross-section ROI center. The thermal drift usually stabilizes after the first hour of acquisition. A sensible way to compensate for the remaining drifts is to track the center of the cross-section ROI and adjust the image with beam shift. Note that beam shift is limited to 50 µm (microscope specifications). 

In the tracking algorithm, two main methods are followed. If incremental drifts are bigger than 1.5 µm, we keep the FOV at the center. If drifts are smaller, we use ASIFT to keep track of the shift. The algorithm has been tested where the section thickness varies from 5 nm to 200 nm. Beyond 50 nm, it is recommended to adapt the parameter *beta* and *gap* from the algorithm to maintain performance. 



